#!/usr/bin/env bash
# cf â€” Cloudflare API wrapper for OpenClaw
# Usage: cf <command> [args...]
#
# Requires: CLOUDFLARE_API_TOKEN environment variable
#           CLOUDFLARE_ACCOUNT_ID for account-level operations (optional)

set -euo pipefail

CF_API="https://api.cloudflare.com/client/v4"
TOKEN="${CLOUDFLARE_API_TOKEN:?Set CLOUDFLARE_API_TOKEN}"

# --- helpers ---

_curl() {
  curl -sS -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" "$@"
}

_get()    { _curl "$CF_API$1"; }
_post()   { _curl -X POST -d "$2" "$CF_API$1"; }
_put()    { _curl -X PUT -d "$2" "$CF_API$1"; }
_patch()  { _curl -X PATCH -d "$2" "$CF_API$1"; }
_delete() { _curl -X DELETE "$CF_API$1"; }

_jq_check() {
  if ! command -v jq &>/dev/null; then
    cat  # passthrough raw JSON
  else
    jq "$@"
  fi
}

# --- zones ---

cmd_zones_list() {
  local args=""
  [[ "${1:-}" ]] && args="?name=$1"
  _get "/zones$args" | _jq_check '.result[] | {id, name, status, name_servers}'
}

cmd_zone_get() {
  local zone_id="${1:?Usage: cf zone-get <zone_id>}"
  _get "/zones/$zone_id" | _jq_check '.result | {id, name, status, name_servers, plan: .plan.name}'
}

# --- DNS records ---

cmd_dns_list() {
  local zone_id="${1:?Usage: cf dns-list <zone_id> [type] [name]}"
  local type="${2:-}" name="${3:-}"
  local qs="?per_page=100"
  [[ "$type" ]] && qs+="&type=$type"
  [[ "$name" ]] && qs+="&name=$name"
  _get "/zones/$zone_id/dns_records$qs" | _jq_check '.result[] | {id, type, name, content, proxied, ttl}'
}

cmd_dns_create() {
  local zone_id="${1:?Usage: cf dns-create <zone_id> <type> <name> <content> [proxied] [ttl]}"
  local type="${2:?}" name="${3:?}" content="${4:?}"
  local proxied="${5:-false}" ttl="${6:-1}"
  local data
  data=$(jq -n --arg t "$type" --arg n "$name" --arg c "$content" \
    --argjson p "$proxied" --argjson ttl "$ttl" \
    '{type:$t, name:$n, content:$c, proxied:$p, ttl:$ttl}')
  _post "/zones/$zone_id/dns_records" "$data" | _jq_check '.result | {id, type, name, content, proxied, ttl}'
}

cmd_dns_update() {
  local zone_id="${1:?Usage: cf dns-update <zone_id> <record_id> <type> <name> <content> [proxied] [ttl]}"
  local record_id="${2:?}" type="${3:?}" name="${4:?}" content="${5:?}"
  local proxied="${6:-false}" ttl="${7:-1}"
  local data
  data=$(jq -n --arg t "$type" --arg n "$name" --arg c "$content" \
    --argjson p "$proxied" --argjson ttl "$ttl" \
    '{type:$t, name:$n, content:$c, proxied:$p, ttl:$ttl}')
  _put "/zones/$zone_id/dns_records/$record_id" "$data" | _jq_check '.result | {id, type, name, content, proxied, ttl}'
}

cmd_dns_delete() {
  local zone_id="${1:?Usage: cf dns-delete <zone_id> <record_id>}"
  local record_id="${2:?}"
  _delete "/zones/$zone_id/dns_records/$record_id" | _jq_check '.'
}

# --- zone settings ---

cmd_settings_list() {
  local zone_id="${1:?Usage: cf settings-list <zone_id>}"
  _get "/zones/$zone_id/settings" | _jq_check '.result[] | {id, value}'
}

cmd_setting_get() {
  local zone_id="${1:?Usage: cf setting-get <zone_id> <setting_id>}"
  local setting="${2:?}"
  _get "/zones/$zone_id/settings/$setting" | _jq_check '.result | {id, value}'
}

cmd_setting_set() {
  local zone_id="${1:?Usage: cf setting-set <zone_id> <setting_id> <value>}"
  local setting="${2:?}" value="${3:?}"
  local data
  data=$(jq -n --arg v "$value" '{value:$v}')
  _patch "/zones/$zone_id/settings/$setting" "$data" | _jq_check '.result | {id, value}'
}

# --- SSL ---

cmd_ssl_get() {
  local zone_id="${1:?Usage: cf ssl-get <zone_id>}"
  _get "/zones/$zone_id/settings/ssl" | _jq_check '.result | {id, value}'
}

cmd_ssl_set() {
  local zone_id="${1:?Usage: cf ssl-set <zone_id> <off|flexible|full|strict>}"
  local mode="${2:?}"
  cmd_setting_set "$zone_id" "ssl" "$mode"
}

# --- page rules ---

cmd_pagerules_list() {
  local zone_id="${1:?Usage: cf pagerules-list <zone_id>}"
  _get "/zones/$zone_id/pagerules" | _jq_check '.result[] | {id, status, targets, actions}'
}

# --- firewall rules (WAF custom rules) ---

cmd_firewall_list() {
  local zone_id="${1:?Usage: cf firewall-list <zone_id>}"
  _get "/zones/$zone_id/firewall/rules" | _jq_check '.result[] | {id, description, action, filter: .filter.expression}'
}

# --- tunnels ---

cmd_tunnels_list() {
  local acct="${CLOUDFLARE_ACCOUNT_ID:?Set CLOUDFLARE_ACCOUNT_ID for tunnel ops}"
  _get "/accounts/$acct/cfd_tunnel" | _jq_check '.result[] | {id, name, status, created_at}'
}

cmd_tunnel_get() {
  local acct="${CLOUDFLARE_ACCOUNT_ID:?Set CLOUDFLARE_ACCOUNT_ID}"
  local tunnel_id="${1:?Usage: cf tunnel-get <tunnel_id>}"
  _get "/accounts/$acct/cfd_tunnel/$tunnel_id" | _jq_check '.result'
}

# --- token verify ---

cmd_verify() {
  _get "/user/tokens/verify" | _jq_check '.result'
}

# --- analytics ---

cmd_analytics() {
  local zone_id="${1:?Usage: cf analytics <zone_id> [since]}"
  local since="${2:--1440}"  # default last 24h in minutes
  _get "/zones/$zone_id/analytics/dashboard?since=$since" | _jq_check '.result.totals'
}

# --- dispatch ---

cmd="${1:?Usage: cf <command> [args...]}"
shift

case "$cmd" in
  verify)          cmd_verify "$@" ;;
  zones|zones-list) cmd_zones_list "$@" ;;
  zone-get)        cmd_zone_get "$@" ;;
  dns-list)        cmd_dns_list "$@" ;;
  dns-create)      cmd_dns_create "$@" ;;
  dns-update)      cmd_dns_update "$@" ;;
  dns-delete)      cmd_dns_delete "$@" ;;
  settings-list)   cmd_settings_list "$@" ;;
  setting-get)     cmd_setting_get "$@" ;;
  setting-set)     cmd_setting_set "$@" ;;
  ssl-get)         cmd_ssl_get "$@" ;;
  ssl-set)         cmd_ssl_set "$@" ;;
  pagerules-list)  cmd_pagerules_list "$@" ;;
  firewall-list)   cmd_firewall_list "$@" ;;
  tunnels-list)    cmd_tunnels_list "$@" ;;
  tunnel-get)      cmd_tunnel_get "$@" ;;
  analytics)       cmd_analytics "$@" ;;
  *) echo "Unknown command: $cmd" >&2; exit 1 ;;
esac
